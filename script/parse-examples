#!/bin/bash

set -eu

example_files="$(find examples -name '*.cs')"
known_failures="$(cat script/known-failures.txt)"

examples_to_parse=()
while read -r example; do
  if [[ ! $known_failures == *$example* ]]; then
    examples_to_parse+=("${example}")
  fi
done <<< "$example_files"

printf "%s\0" "${examples_to_parse[@]}" | xargs -0 -n 2000 tree-sitter parse -q

skipped=$(echo "$known_failures" | wc -l)
parsed=$(printf "%s\n" "${examples_to_parse[@]}" | wc -l)
total=$((parsed+skipped))
percent=$(bc -l <<< "100*$parsed/$total")

printf "Successfully parsed %d of %d example files (%.1f%%)\n" $parsed $total $percent
