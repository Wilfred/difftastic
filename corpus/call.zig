================================================================================
call
================================================================================

    const std = @import("std");
const expect = std.testing.expect;
const expectEqual = std.testing.expectEqual;

test "basic invocations" {
    const foo = struct {
        fn foo() i32 {
            return 1234;
        }
    }.foo;
    expect(@call(.{}, foo, .{}) == 1234);
    comptime {
        // modifiers that allow comptime calls
        expect(@call(.{}, foo, .{}) == 1234);
        expect(@call(.{ .modifier = .no_async }, foo, .{}) == 1234);
        expect(@call(.{ .modifier = .always_tail }, foo, .{}) == 1234);
        expect(@call(.{ .modifier = .always_inline }, foo, .{}) == 1234);
    }
    {
        // comptime call without comptime keyword
        const result = @call(.{ .modifier = .compile_time }, foo, .{}) == 1234;
        comptime expect(result);
    }
    {
        // call of non comptime-known function
        var alias_foo = foo;
        expect(@call(.{ .modifier = .no_async }, alias_foo, .{}) == 1234);
        expect(@call(.{ .modifier = .never_tail }, alias_foo, .{}) == 1234);
        expect(@call(.{ .modifier = .never_inline }, alias_foo, .{}) == 1234);
    }
}

test "tuple parameters" {
    const add = struct {
        fn add(a: i32, b: i32) i32 {
            return a + b;
        }
    }.add;
    var a: i32 = 12;
    var b: i32 = 34;
    expect(@call(.{}, add, .{ a, 34 }) == 46);
    expect(@call(.{}, add, .{ 12, b }) == 46);
    expect(@call(.{}, add, .{ a, b }) == 46);
    expect(@call(.{}, add, .{ 12, 34 }) == 46);
    comptime expect(@call(.{}, add, .{ 12, 34 }) == 46);
    {
        const separate_args0 = .{ a, b };
        const separate_args1 = .{ a, 34 };
        const separate_args2 = .{ 12, 34 };
        const separate_args3 = .{ 12, b };
        expect(@call(.{ .modifier = .always_inline }, add, separate_args0) == 46);
        expect(@call(.{ .modifier = .always_inline }, add, separate_args1) == 46);
        expect(@call(.{ .modifier = .always_inline }, add, separate_args2) == 46);
        expect(@call(.{ .modifier = .always_inline }, add, separate_args3) == 46);
    }
}

test "comptime call with bound function as parameter" {
    const S = struct {
        fn ReturnType(func: anytype) type {
            return switch (@typeInfo(@TypeOf(func))) {
                .BoundFn => |info| info,
                else => unreachable,
            }.return_type orelse void;
        }

        fn call_me_maybe() ?i32 {
            return 123;
        }
    };

    var inst: S = undefined;
    expectEqual(?i32, S.ReturnType(inst.call_me_maybe));
}

--------------------------------------------------------------------------------

(source_file
  (VarDecl
    (IDENTIFIER)
    (SuffixExpr
      (BUILTINIDENTIFIER)
      (FnCallArguments
        (SuffixExpr
          (STRINGLITERAL
            (STRINGLITERALSINGLE))))))
  (VarDecl
    (IDENTIFIER)
    (SuffixExpr
      (IDENTIFIER)
      (SuffixOp
        (IDENTIFIER))
      (SuffixOp
        (IDENTIFIER))))
  (VarDecl
    (IDENTIFIER)
    (SuffixExpr
      (IDENTIFIER)
      (SuffixOp
        (IDENTIFIER))
      (SuffixOp
        (IDENTIFIER))))
  (TestDecl
    (STRINGLITERALSINGLE)
    (Block
      (VarDecl
        (IDENTIFIER)
        (SuffixExpr
          (ContainerDecl
            (ContainerDeclType)
            (FnProto
              (IDENTIFIER)
              (ParamDeclList)
              (SuffixExpr
                (BuildinTypeExpr)))
            (Block
              (AssignExpr
                (SuffixExpr
                  (INTEGER)))))
          (SuffixOp
            (IDENTIFIER))))
      (AssignExpr
        (SuffixExpr
          (IDENTIFIER)
          (FnCallArguments
            (BinaryExpr
              (SuffixExpr
                (BUILTINIDENTIFIER)
                (FnCallArguments
                  (SuffixExpr
                    (InitList))
                  (SuffixExpr
                    (IDENTIFIER))
                  (SuffixExpr
                    (InitList))))
              (CompareOp)
              (SuffixExpr
                (INTEGER))))))
      (BlockExprStatement
        (BlockExpr
          (Block
            (line_comment)
            (AssignExpr
              (SuffixExpr
                (IDENTIFIER)
                (FnCallArguments
                  (BinaryExpr
                    (SuffixExpr
                      (BUILTINIDENTIFIER)
                      (FnCallArguments
                        (SuffixExpr
                          (InitList))
                        (SuffixExpr
                          (IDENTIFIER))
                        (SuffixExpr
                          (InitList))))
                    (CompareOp)
                    (SuffixExpr
                      (INTEGER))))))
            (AssignExpr
              (SuffixExpr
                (IDENTIFIER)
                (FnCallArguments
                  (BinaryExpr
                    (SuffixExpr
                      (BUILTINIDENTIFIER)
                      (FnCallArguments
                        (SuffixExpr
                          (InitList
                            (FieldInit
                              (IDENTIFIER)
                              (SuffixExpr
                                (IDENTIFIER)))))
                        (SuffixExpr
                          (IDENTIFIER))
                        (SuffixExpr
                          (InitList))))
                    (CompareOp)
                    (SuffixExpr
                      (INTEGER))))))
            (AssignExpr
              (SuffixExpr
                (IDENTIFIER)
                (FnCallArguments
                  (BinaryExpr
                    (SuffixExpr
                      (BUILTINIDENTIFIER)
                      (FnCallArguments
                        (SuffixExpr
                          (InitList
                            (FieldInit
                              (IDENTIFIER)
                              (SuffixExpr
                                (IDENTIFIER)))))
                        (SuffixExpr
                          (IDENTIFIER))
                        (SuffixExpr
                          (InitList))))
                    (CompareOp)
                    (SuffixExpr
                      (INTEGER))))))
            (AssignExpr
              (SuffixExpr
                (IDENTIFIER)
                (FnCallArguments
                  (BinaryExpr
                    (SuffixExpr
                      (BUILTINIDENTIFIER)
                      (FnCallArguments
                        (SuffixExpr
                          (InitList
                            (FieldInit
                              (IDENTIFIER)
                              (SuffixExpr
                                (IDENTIFIER)))))
                        (SuffixExpr
                          (IDENTIFIER))
                        (SuffixExpr
                          (InitList))))
                    (CompareOp)
                    (SuffixExpr
                      (INTEGER)))))))))
      (LabeledStatement
        (Block
          (line_comment)
          (VarDecl
            (IDENTIFIER)
            (BinaryExpr
              (SuffixExpr
                (BUILTINIDENTIFIER)
                (FnCallArguments
                  (SuffixExpr
                    (InitList
                      (FieldInit
                        (IDENTIFIER)
                        (SuffixExpr
                          (IDENTIFIER)))))
                  (SuffixExpr
                    (IDENTIFIER))
                  (SuffixExpr
                    (InitList))))
              (CompareOp)
              (SuffixExpr
                (INTEGER))))
          (AssignExpr
            (SuffixExpr
              (SuffixExpr
                (IDENTIFIER))
              (FnCallArguments
                (SuffixExpr
                  (IDENTIFIER)))))))
      (LabeledStatement
        (Block
          (line_comment)
          (VarDecl
            (IDENTIFIER)
            (SuffixExpr
              (IDENTIFIER)))
          (AssignExpr
            (SuffixExpr
              (IDENTIFIER)
              (FnCallArguments
                (BinaryExpr
                  (SuffixExpr
                    (BUILTINIDENTIFIER)
                    (FnCallArguments
                      (SuffixExpr
                        (InitList
                          (FieldInit
                            (IDENTIFIER)
                            (SuffixExpr
                              (IDENTIFIER)))))
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (InitList))))
                  (CompareOp)
                  (SuffixExpr
                    (INTEGER))))))
          (AssignExpr
            (SuffixExpr
              (IDENTIFIER)
              (FnCallArguments
                (BinaryExpr
                  (SuffixExpr
                    (BUILTINIDENTIFIER)
                    (FnCallArguments
                      (SuffixExpr
                        (InitList
                          (FieldInit
                            (IDENTIFIER)
                            (SuffixExpr
                              (IDENTIFIER)))))
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (InitList))))
                  (CompareOp)
                  (SuffixExpr
                    (INTEGER))))))
          (AssignExpr
            (SuffixExpr
              (IDENTIFIER)
              (FnCallArguments
                (BinaryExpr
                  (SuffixExpr
                    (BUILTINIDENTIFIER)
                    (FnCallArguments
                      (SuffixExpr
                        (InitList
                          (FieldInit
                            (IDENTIFIER)
                            (SuffixExpr
                              (IDENTIFIER)))))
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (InitList))))
                  (CompareOp)
                  (SuffixExpr
                    (INTEGER))))))))))
  (TestDecl
    (STRINGLITERALSINGLE)
    (Block
      (VarDecl
        (IDENTIFIER)
        (SuffixExpr
          (ContainerDecl
            (ContainerDeclType)
            (FnProto
              (IDENTIFIER)
              (ParamDeclList
                (ParamDecl
                  (IDENTIFIER)
                  (ParamType
                    (SuffixExpr
                      (BuildinTypeExpr))))
                (ParamDecl
                  (IDENTIFIER)
                  (ParamType
                    (SuffixExpr
                      (BuildinTypeExpr)))))
              (SuffixExpr
                (BuildinTypeExpr)))
            (Block
              (AssignExpr
                (BinaryExpr
                  (SuffixExpr
                    (IDENTIFIER))
                  (AdditionOp)
                  (SuffixExpr
                    (IDENTIFIER))))))
          (SuffixOp
            (IDENTIFIER))))
      (VarDecl
        (IDENTIFIER)
        (SuffixExpr
          (BuildinTypeExpr))
        (SuffixExpr
          (INTEGER)))
      (VarDecl
        (IDENTIFIER)
        (SuffixExpr
          (BuildinTypeExpr))
        (SuffixExpr
          (INTEGER)))
      (AssignExpr
        (SuffixExpr
          (IDENTIFIER)
          (FnCallArguments
            (BinaryExpr
              (SuffixExpr
                (BUILTINIDENTIFIER)
                (FnCallArguments
                  (SuffixExpr
                    (InitList))
                  (SuffixExpr
                    (IDENTIFIER))
                  (SuffixExpr
                    (InitList
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (INTEGER))))))
              (CompareOp)
              (SuffixExpr
                (INTEGER))))))
      (AssignExpr
        (SuffixExpr
          (IDENTIFIER)
          (FnCallArguments
            (BinaryExpr
              (SuffixExpr
                (BUILTINIDENTIFIER)
                (FnCallArguments
                  (SuffixExpr
                    (InitList))
                  (SuffixExpr
                    (IDENTIFIER))
                  (SuffixExpr
                    (InitList
                      (SuffixExpr
                        (INTEGER))
                      (SuffixExpr
                        (IDENTIFIER))))))
              (CompareOp)
              (SuffixExpr
                (INTEGER))))))
      (AssignExpr
        (SuffixExpr
          (IDENTIFIER)
          (FnCallArguments
            (BinaryExpr
              (SuffixExpr
                (BUILTINIDENTIFIER)
                (FnCallArguments
                  (SuffixExpr
                    (InitList))
                  (SuffixExpr
                    (IDENTIFIER))
                  (SuffixExpr
                    (InitList
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (IDENTIFIER))))))
              (CompareOp)
              (SuffixExpr
                (INTEGER))))))
      (AssignExpr
        (SuffixExpr
          (IDENTIFIER)
          (FnCallArguments
            (BinaryExpr
              (SuffixExpr
                (BUILTINIDENTIFIER)
                (FnCallArguments
                  (SuffixExpr
                    (InitList))
                  (SuffixExpr
                    (IDENTIFIER))
                  (SuffixExpr
                    (InitList
                      (SuffixExpr
                        (INTEGER))
                      (SuffixExpr
                        (INTEGER))))))
              (CompareOp)
              (SuffixExpr
                (INTEGER))))))
      (AssignExpr
        (SuffixExpr
          (SuffixExpr
            (IDENTIFIER))
          (FnCallArguments
            (BinaryExpr
              (SuffixExpr
                (BUILTINIDENTIFIER)
                (FnCallArguments
                  (SuffixExpr
                    (InitList))
                  (SuffixExpr
                    (IDENTIFIER))
                  (SuffixExpr
                    (InitList
                      (SuffixExpr
                        (INTEGER))
                      (SuffixExpr
                        (INTEGER))))))
              (CompareOp)
              (SuffixExpr
                (INTEGER))))))
      (LabeledStatement
        (Block
          (VarDecl
            (IDENTIFIER)
            (SuffixExpr
              (InitList
                (SuffixExpr
                  (IDENTIFIER))
                (SuffixExpr
                  (IDENTIFIER)))))
          (VarDecl
            (IDENTIFIER)
            (SuffixExpr
              (InitList
                (SuffixExpr
                  (IDENTIFIER))
                (SuffixExpr
                  (INTEGER)))))
          (VarDecl
            (IDENTIFIER)
            (SuffixExpr
              (InitList
                (SuffixExpr
                  (INTEGER))
                (SuffixExpr
                  (INTEGER)))))
          (VarDecl
            (IDENTIFIER)
            (SuffixExpr
              (InitList
                (SuffixExpr
                  (INTEGER))
                (SuffixExpr
                  (IDENTIFIER)))))
          (AssignExpr
            (SuffixExpr
              (IDENTIFIER)
              (FnCallArguments
                (BinaryExpr
                  (SuffixExpr
                    (BUILTINIDENTIFIER)
                    (FnCallArguments
                      (SuffixExpr
                        (InitList
                          (FieldInit
                            (IDENTIFIER)
                            (SuffixExpr
                              (IDENTIFIER)))))
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (IDENTIFIER))))
                  (CompareOp)
                  (SuffixExpr
                    (INTEGER))))))
          (AssignExpr
            (SuffixExpr
              (IDENTIFIER)
              (FnCallArguments
                (BinaryExpr
                  (SuffixExpr
                    (BUILTINIDENTIFIER)
                    (FnCallArguments
                      (SuffixExpr
                        (InitList
                          (FieldInit
                            (IDENTIFIER)
                            (SuffixExpr
                              (IDENTIFIER)))))
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (IDENTIFIER))))
                  (CompareOp)
                  (SuffixExpr
                    (INTEGER))))))
          (AssignExpr
            (SuffixExpr
              (IDENTIFIER)
              (FnCallArguments
                (BinaryExpr
                  (SuffixExpr
                    (BUILTINIDENTIFIER)
                    (FnCallArguments
                      (SuffixExpr
                        (InitList
                          (FieldInit
                            (IDENTIFIER)
                            (SuffixExpr
                              (IDENTIFIER)))))
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (IDENTIFIER))))
                  (CompareOp)
                  (SuffixExpr
                    (INTEGER))))))
          (AssignExpr
            (SuffixExpr
              (IDENTIFIER)
              (FnCallArguments
                (BinaryExpr
                  (SuffixExpr
                    (BUILTINIDENTIFIER)
                    (FnCallArguments
                      (SuffixExpr
                        (InitList
                          (FieldInit
                            (IDENTIFIER)
                            (SuffixExpr
                              (IDENTIFIER)))))
                      (SuffixExpr
                        (IDENTIFIER))
                      (SuffixExpr
                        (IDENTIFIER))))
                  (CompareOp)
                  (SuffixExpr
                    (INTEGER))))))))))
  (TestDecl
    (STRINGLITERALSINGLE)
    (Block
      (VarDecl
        (IDENTIFIER)
        (SuffixExpr
          (ContainerDecl
            (ContainerDeclType)
            (FnProto
              (IDENTIFIER)
              (ParamDeclList
                (ParamDecl
                  (IDENTIFIER)
                  (ParamType)))
              (SuffixExpr
                (BuildinTypeExpr)))
            (Block
              (AssignExpr
                (BinaryExpr
                  (SuffixExpr
                    (SwitchExpr
                      (SuffixExpr
                        (BUILTINIDENTIFIER)
                        (FnCallArguments
                          (SuffixExpr
                            (BUILTINIDENTIFIER)
                            (FnCallArguments
                              (SuffixExpr
                                (IDENTIFIER))))))
                      (SwitchProngList
                        (SwitchProng
                          (SwitchCase
                            (SwitchItem
                              (SuffixExpr
                                (IDENTIFIER))))
                          (PtrPayload
                            (IDENTIFIER))
                          (AssignExpr
                            (SuffixExpr
                              (IDENTIFIER))))
                        (SwitchProng
                          (SwitchCase)
                          (AssignExpr
                            (SuffixExpr)))))
                    (SuffixOp
                      (IDENTIFIER)))
                  (BitwiseOp)
                  (SuffixExpr
                    (BuildinTypeExpr)))))
            (FnProto
              (IDENTIFIER)
              (ParamDeclList)
              (PrefixTypeOp)
              (SuffixExpr
                (BuildinTypeExpr)))
            (Block
              (AssignExpr
                (SuffixExpr
                  (INTEGER)))))))
      (VarDecl
        (IDENTIFIER)
        (SuffixExpr
          (IDENTIFIER))
        (SuffixExpr))
      (AssignExpr
        (SuffixExpr
          (IDENTIFIER)
          (FnCallArguments
            (PrefixTypeOp)
            (SuffixExpr
              (BuildinTypeExpr))
            (SuffixExpr
              (IDENTIFIER)
              (SuffixOp
                (IDENTIFIER))
              (FnCallArguments
                (SuffixExpr
                  (IDENTIFIER)
                  (SuffixOp
                    (IDENTIFIER)))))))))))
